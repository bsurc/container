Bootstrap: yum
OSVersion: 7.5.1804
MirrorURL: http://mirrors.syringanetworks.net/centos/7/os/x86_64/
Include: yum

%post

	yum -y groupinstall "Development Tools"
	yum -y install wget curl infinitpath-psm mlocate which kernel-devel epel-release vim glibc-devel.i686 blas lapack libgcc libgcc.i686 readline-devel
	yum -y install zlib-devel bzip2-devel xz-devel pcre-devel libcurl-devel libsqlite3x-devel.x86_64 pkgconfig udunits2-devel
	ionice -c3 updatedb
	mkdir peregrine
	cd peregrine
	
	yum -y install https://download1.rpmfusion.org/free/el/rpmfusion-free-release-7.noarch.rpm
	yum -y install geos-devel
	
	wget --user-agent="Mozilla" "http://www.openbugs.net/w/OpenBUGS_3_2_3?action=AttachFile&do=get&target=OpenBUGS-3.2.3.tar.gz"
	pwd
	tar -xf "OpenBUGS_3_2_3?action=AttachFile&do=get&target=OpenBUGS-3.2.3.tar.gz"
	cd OpenBUGS-3.2.3
	./configure
	make
	make install
	cd ..
	
	wget http://www.netlib.org/blas/blas-3.8.0.tgz
	tar -xf blas-3.8.0.tgz
	cd BLAS-3.8.0
	make
	gfortran -c -fPIC *.f
	ar rv libblas.a *.o
	cp libblas.a /usr/lib64
	cp libblas.a /usr/lib64/libblas.so
	rm -rf *.o
	rm -rf *.f
	mv /usr/lib64/liblapack.so.3.4.2 /usr/lib64/liblapack.so
	cd ..
	
	wget https://sourceforge.net/projects/mcmc-jags/files/JAGS/4.x/Source/JAGS-4.3.0.tar.gz/download
	mv download download.tar.gz
	tar -xf download.tar.gz
	cd JAGS-4.3.0
	LDFLAGS="-L/usr/lib64" ./configure --with-blas="-L/usr/lib64/libblas.so" --with-lapack="-L/usr/lib64/liblapack.so.3.4.2 --prefix=/peregrine/JAGS-4.3.0"
	make
	make install
	ionice -c3 updatedb
	locate jags.pc
		
	yum install -y python36-pip-8.1.2-8.el7.noarch
	curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
	python get-pip.py

	python --version
	python3 --version

	cd .. 
	wget https://cran.r-project.org/src/base/R-3/R-3.6.0.tar.gz
	tar -xf R-3.6.0.tar.gz
	cd R-3.6.0
	./configure --with-x=no --enable-R-shlib=yes
	make
	make install
	
	cd ..
        git clone https://github.com/OSGeo/PROJ.git
        cd PROJ
	./autogen.sh
        ./configure
        make
        make install

	cd ..
	wget https://github.com/OSGeo/gdal/releases/download/v3.0.1/gdal-3.0.1.tar.gz
	tar -xf gdal-3.0.1.tar.gz
	cd gdal-3.0.1
	./configure
	make
	make install
	
	export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig/
	export LD_RUN_PATH=/usr/local/lib:$LD_RUN_PATH
	ionice -c3 updatedb
	locate proj.pc
		
	cd ..
	echo "install.packages('units', repos='https://cran.cnr.berkeley.edu/')" >> packages.R
	echo "install.packages('jagsUI', repos='https://cran.cnr.berkeley.edu/')" >> packages.R
    	echo "install.packages('R2OpenBUGS', repos='https://cran.cnr.berkeley.edu/')" >> packages.R
    	echo "install.packages('nimble', repos='https://cran.cnr.berkeley.edu/')" >> packages.R
    	echo "install.packages('rjags', repos='https://cran.cnr.berkeley.edu/')" >> packages.R
    	echo "install.packages('R2jags', repos='https://cran.cnr.berkeley.edu/')" >> packages.R
    	echo "install.packages('reshape2', repos='https://cran.cnr.berkeley.edu/')" >> packages.R
    	echo "install.packages('tidyr', repos='https://cran.cnr.berkeley.edu/')" >> packages.R
    	echo "install.packages('dplyr', repos='https://cran.cnr.berkeley.edu/')" >> packages.R
	echo "install.packages('sf', repos='https://cran.cnr.berkeley.edu/')" >> packages.R
		
	echo "install.packages('raster', repos='https://cran.cnr.berkeley.edu/')" >> other.R
        echo "install.packages('sp', repos='https://cran.cnr.berkeley.edu/')" >> other.R
        echo "install.packages('rgdal', repos='https://cran.cnr.berkeley.edu/')" >> other.R
        echo "install.packages('rgeos', repos='https://cran.cnr.berkeley.edu/')" >> other.R
        echo "install.packages('unmarked', repos='https://cran.cnr.berkeley.edu/')" >> other.R
        echo "install.packages('maxnet', repos='https://cran.cnr.berkeley.edu/')" >> other.R
        echo "install.packages('ENMeval', repos='https://cran.cnr.berkeley.edu/')" >> other.R
        echo "install.packages('dplyr', repos='https://cran.cnr.berkeley.edu/')" >> other.R
	echo "install.packages('spThin', repos='https://cran.cnr.berkeley.edu/')" >> other.R
        echo "install.packages('lubridate', repos='https://cran.cnr.berkeley.edu/')" >> other.R
        echo "install.packages('landscapemetrics', repos='https://cran.cnr.berkeley.edu/')" >> other.R
        echo "install.packages('data.table', repos='https://cran.cnr.berkeley.edu/')" >> other.R
        echo "install.packages('RPyGeo', repos='https://cran.cnr.berkeley.edu/')" >> other.R
	echo "install.packages('INLA', repos=c(getOption('repos'), INLA='https://inla.r-inla-download.org/R/stable'), dep=TRUE)" >> other.R

	Rscript packages.R	
	Rscript other.R

%labels
forrest_version peregrine.def
