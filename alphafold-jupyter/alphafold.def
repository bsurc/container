Bootstrap: docker
From: ubuntu:noble-20241011

# Build instructions from
# https://github.com/kalininalab/alphafold_non_docker

%files

%post
    apt -y update
    apt -y install wget git
    apt clean

    # Install miniforge
    wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh
    bash ./Miniforge3-Linux-x86_64.sh -b -p /opt/conda
    . /opt/conda/etc/profile.d/conda.sh
    conda activate base
    conda update --yes --all
    conda clean --yes --all
    rm ./Miniforge3-Linux-x86_64.sh
    mamba create --name alphafold -c conda-forge -c bioconda python \
        openmm cudnn cudatoolkit pdbfixer hmmer hhsuite kalign2 \
        absl-py==1.0.0 biopython==1.79 chex==0.1.86 dm-haiku==0.0.12 \
        dm-tree==0.1.8 docker==5.0.0 immutabledict==2.0.0 jax==0.4.26 \
        ml-collections==0.1.0 numpy==1.24.3 pandas==2.0.3 scipy==1.11.1 \
        tensorflow-cpu==2.16.1 jupyter notebook jupyter lab
    conda activate alphafold

    # alphafold setup
    cd /opt/
    git clone https://github.com/deepmind/alphafold.git
    alphafold_path="/opt/alphafold"

    wget -q -P alphafold/alphafold/common/ https://git.scicore.unibas.ch/schwede/openstructure/-/raw/7102c63615b64735c4941278d92b554ec94415f8/modules/mol/alg/src/stereo_chemical_props.txt

    cd /opt/miniforge3/envs/alphafold/lib/python3.8/site-packages/ && \
        patch -p0 < $alphafold_path/docker/openmm.patch
    chmod +x /opt/alphafold/*.py

%environment
    export LC_ALL=C.UTF-8
    export PATH=/opt/miniforge3/envs/alphafold/bin:$PATH
