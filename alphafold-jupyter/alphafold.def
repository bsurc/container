Bootstrap: docker
From: ubuntu:noble-20241011

# Build instructions from
# https://github.com/kalininalab/alphafold_non_docker

%files

%post
    apt -y update
    apt -y install wget git tar
    apt clean

    # Install miniforge
    wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh
    bash ./Miniforge3-Linux-x86_64.sh -b -p /opt/conda
    . /opt/conda/etc/profile.d/conda.sh
    conda activate base
    conda update --yes --all
    conda clean --yes --all
    rm ./Miniforge3-Linux-x86_64.sh
    mamba create -y -q --name alphafold -c conda-forge -c bioconda python \
        openmm==7.5.1 pdbfixer hmmer hhsuite kalign2 \
        absl-py==1.0.0 biopython==1.79 chex==0.0.7 dm-haiku \
        dm-tree==0.1.6 immutabledict==2.0.0 jax==0.3.25 \
        ml-collections numpy==1.21.6 pandas==1.3.4 scipy==1.7.0 \
        tensorflow-cpu==2.11.1 jupyter notebook jupyterlab
    conda activate alphafold

    # alphafold setup
    cd /opt/
    wget https://github.com/google-deepmind/alphafold/archive/refs/tags/v2.3.2.tar.gz
    tar xzf v2.3.2.tar.gz
    rm v2.3.2.tar.gz
    alphafold_path="/opt/alphafold-2.3.2"
    cd $alphafold_path
    pip install .

    wget -q -P $alphafold_path/alphafold/common/ https://git.scicore.unibas.ch/schwede/openstructure/-/raw/7102c63615b64735c4941278d92b554ec94415f8/modules/mol/alg/src/stereo_chemical_props.txt

    cd /opt/miniforge3/envs/alphafold/lib/python3.8/site-packages/ && \
        patch -p0 < $alphafold_path/docker/openmm.patch
    chmod +x /opt/alphafold/*.py

%environment
    export LC_ALL=C.UTF-8
    export PATH=/opt/miniforge3/envs/alphafold/bin:$PATH
