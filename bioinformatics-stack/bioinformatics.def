Bootstrap: docker
From: ubuntu:focal


%files

%post
	export DEBIAN_FRONTEND="noninteractive"
	apt -y update && apt -y dist-upgrade
	apt -y install wget bzip2 unzip zip git
	apt -y install default-jre default-jdk
	apt -y install samtools
	apt install -y iqtree
        echo "deb http://dk.archive.ubuntu.com/ubuntu/ xenial main" >> /etc/apt/sources.list
        echo "deb http://dk.archive.ubuntu.com/ubuntu/ xenial universe" >> /etc/apt/sources.list
	apt update
	apt install -y gcc-5 g++-5

	# Install conda
	wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
	chmod +x Miniconda3-latest-Linux-x86_64.sh
	bash ./Miniconda3-latest-Linux-x86_64.sh -b -p /opt/conda
     	. /opt/conda/etc/profile.d/conda.sh
    	conda activate base
    	conda update --yes --all
    	conda clean --yes --all
	rm ./Miniconda3-latest-Linux-x86_64.sh

	# Install mamba and getorganelle, treeshrink, biopython	
	conda install -n base -c conda-forge mamba
	mamba install -c conda-forge -c bioconda -c smirarab biopython bmge bwa getorganelle treeshrink parallel
	
	# Configure GetOrganelle
	mkdir /opt/get_organelle_db
	get_organelle_config.py --add embplant_pt,embplant_mt,embplant_nr --config-dir /opt/get_organelle_db

	# Download and Extract ASTRAL
	wget https://github.com/smirarab/ASTRAL/raw/master/Astral.5.7.8.zip
	unzip Astral.5.7.8.zip -d /opt
	chmod -R 777 /opt/Astral

	# Download and Extract bpp
	wget https://github.com/bpp/bpp/releases/download/v4.4.1/bpp-4.4.1-linux-x86_64.tar.gz
	tar zxvf bpp-4.4.1-linux-x86_64.tar.gz -C /opt
	# Download and Extract exonerate
	wget http://ftp.ebi.ac.uk/pub/software/vertebrategenomics/exonerate/exonerate-2.2.0-x86_64.tar.gz
	tar zxvf exonerate-2.2.0-x86_64.tar.gz -C /opt
	# Download FastTree
	wget http://www.microbesonline.org/fasttree/FastTree
	mkdir /opt/fasttree
	mv FastTree /opt/fasttree
	chmod -R +x /opt/fasttree

	# Download HybPiper
	cd /opt
	git clone -b v1.3.1 --depth 1 https://github.com/mossmatters/HybPiper.git

	# Install iBPP
	cd /opt
	git clone --branch v2.1.3 --depth 1 https://github.com/cecileane/iBPP.git
	chmod -R 777 iBPP
	cd iBPP/src
	gcc-5 -o ibpp -O3 -std=c89 bpp.c tools.c -lm
	# Are the simulation tools needed? If so add
	gcc-5 -o ibpp-simul -DSIMULATION -O3 -std=c89 bpp.c tools.c -lm

	# Install mafft
	wget https://mafft.cbrc.jp/alignment/software/mafft_7.490-1_amd64.deb
	dpkg -i mafft_7.490-1_amd64.deb


%environment
 	export LC_ALL=C.UTF-8
    	export PATH=/opt/conda/bin:/opt/bpp-4.4.1-linux-x86_64/bin:/opt/exonerate-2.2.0-x86_64/bin:/opt/fasttree:/opt/HybPiper:/opt/iBPP/src:$PATH

%runscript

%startscript
