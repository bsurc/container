#TODO: switch to appropriate library link
Bootstrap: localimage
From: /home/kyle/src/simages/alpine/v3.15.0

%environment
export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8
export LANGUAGE=en_US

%post
export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8
export LANGUAGE=en_US

apk update
apk upgrade

apk add \
  autoconf \
  automake \
  bison \
  build-base \
  cmake \
  expat-dev \
  flex \
  fontconfig \
  font-noto \
  font-noto-extra \
  gdal-dev \
  geos-dev \
  git \
  libgit2-dev \
  libtbb \
  libtool \
  libuv-dev \
  libxml2-dev \
  linux-headers \
  m4 \
  proj-dev \
  R \
  R-dev \
  sqlite-dev \
  texinfo \
  tzdata

mkdir /opt/src
cd /opt/src
git clone https://github.com/Unidata/UDUNITS-2
mkdir UDUNITS-2/build
cd /opt/src/UDUNITS-2/build
cmake -DCMAKE_INSTALL_PREFIX=/usr/local ..
make -j 4
make install

cd /opt

cat << EOF > pkgs.R

pkgs <- c(
  'codetools',
  'devtools',
  'raster',
  'dplyr',
  'rgeos',
  'rgdal',
  'sp',
  'sf',
  'maptools',
  'ggplot2',
  'wesanderson',
  'units',
  'ggnewscale',
  'terra',
  'scales',
  'remotes',
  'igraph',
  'spdep',
  'spatialreg',
  'RColorBrewer',
  'tmap',
  'brms',
  'tidyr',
  'purrr',
  'tibble',
  'stringr',
  'forcats',
  'readr',
  'ggdist',
  'tidybayes',
  'ape'
  )

install.packages(pkgs, repo='https://ftp.osuosl.org/pub/cran/', Ncpus=24)

EOF

Rscript pkgs.R

%test

# make sure we can load all the packages we downloaded/installed

R -e "library(codetools)"
R -e "library(devtools)"
R -e "library(raster)"
R -e "library(dplyr)"
R -e "library(rgeos)"
R -e "library(rgdal)"
R -e "library(sp)"
R -e "library(sf)"
R -e "library(maptools)"
R -e "library(ggplot2)"
R -e "library(wesanderson)"
R -e "library(units)"
R -e "library(ggnewscale)"
R -e "library(terra)"
R -e "library(scales)"
R -e "library(remotes)"
R -e "library(igraph)"
R -e "library(spdep)"
R -e "library(spatialreg)"
R -e "library(RColorBrewer)"
R -e "library(tmap)"
R -e "library(brms)"
R -e "library(tidyr)"
R -e "library(purrr)"
R -e "library(tibble)"
R -e "library(stringr)"
R -e "library(forcats)"
R -e "library(readr)"
R -e "library(ggdist)"
R -e "library(tidybayes)"
R -e "library(ape)"

%help

This container supplies dependencies for Fiona Noonan's thesis project.

%labels

author "Kyle Shannon <kyle@pobox.com>
